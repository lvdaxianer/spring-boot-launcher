name: Release & Changelog

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  release:
    types: [created]

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.6'

jobs:
  sync-gitee:
    name: Sync to Gitee
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Sync to Gitee
        uses: wearerequired/git-mirror-action@master
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          source-repo: "github.com/lvdaxianer/spring-boot-launcher"
          destination-repo: "gitee.com/breakpoint-transfer-launcher/spring-boot-launcher"

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v') || github.event.action == 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Set up Maven
        run: |
          mkdir -p $HOME/.m2
          curl -fsSL https://archive.apache.org/dist/maven/maven-3/${{ env.MAVEN_VERSION }}/binaries/apache-maven-${{ env.MAVEN_VERSION }}-bin.tar.gz | tar -xzC $HOME/.m2
          echo "$HOME/.m2/apache-maven-${{ env.MAVEN_VERSION }}/bin" >> $GITHUB_PATH

      - name: Build project
        run: mvn clean package -DskipTests -B

      - name: Generate Changelog
        run: |
          mvn org.gitlab4j:git-changelog-maven-plugin:changelog -B
          echo "=== Generated CHANGELOG.md ==="
          cat CHANGELOG.md

      - name: Prepare Release Notes
        id: release-notes
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
          RELEASE_NOTES=$(cat << 'EOF'
          ## ğŸ“¦ Release v${VERSION}

          ### ğŸ“ æ›´æ–°æ—¥å¿—

          EOF
          )

          # ä» CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„æ¡ç›®
          CONTENT=$(awk -v ver="\[${VERSION}\]" '
            $0 ~ ver { found=1; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          if [ -z "$CONTENT" ]; then
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç‰ˆæœ¬æ¡ç›®ï¼Œä½¿ç”¨ git log
            CONTENT=$(git log --oneline --since="2024-01-01" -20)
          fi

          # ç»„åˆ Release Notes
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES$CONTENT" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](./CHANGELOG.md)" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          body_path: ${{ env.GITHUB_OUTPUT }}
          body_format: text
          files: |
            target/*.jar
            CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-v${{ steps.version.outputs.version }}
          path: |
            target/*.jar
            CHANGELOG.md

  prerelease:
    name: Pre-release Check
    if: github.event.action != 'created'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new commits
        id: commits
        run: |
          git fetch origin main
          COMMITS=$(git log origin/main..HEAD --oneline | wc -l)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "Found $COMMITS new commits since last release"

      - name: Generate Preview Changelog
        if: steps.commits.outputs.commits > 0
        run: |
          echo "=== Pending Changes ==="
          git log origin/main..HEAD --oneline --pretty=format:"* %s (%h)" -20
          echo ""
          echo "Run 'git tag vx.x.x' to create a release"

  update-changelog:
    name: Update CHANGELOG.md
    if: github.event.action == 'created' && contains(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Update CHANGELOG.md for released version
        run: |
          VERSION=${{ github.ref_name }}

          # å°† Unreleased éƒ¨åˆ†ç§»åŠ¨åˆ°æ–°ç‰ˆæœ¬
          awk -v ver="$VERSION" -v date=$(date +'%Y-%m-%d') '
            /^## \[Unreleased\]/ {
              print $0
              getline
              while (NR && !/^## \[/) { getline }
              if (/^## \[/) {
                print ""
                print "## [" ver "] - " date
                print ""
                print "### Added"
                print "- See GitHub Release for details"
                print ""
                print $0
              }
              exit
            }
            /^## \[Unreleased\]$/ {
              print $0
              print ""
              print "## [" ver "] - " date
              print ""
              print "### Added"
              print "- See GitHub Release for details"
              print ""
            }
            1
          ' CHANGELOG.md > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md

      - name: Commit updated CHANGELOG
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for v${{ github.ref_name }}"
          git push
